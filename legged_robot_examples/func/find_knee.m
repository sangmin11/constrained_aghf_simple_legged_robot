function p_knee = find_knee(p_hip, p_foot, r1, r2, flag)

x1 = p_hip(1);
y1 = p_hip(2);
x2 = p_foot(1);
y2 = p_foot(2);

if flag~=1
    if x1==x2
        x3 = -(r1^2-((y1-y2)*r1/(r1+r2))^2)^0.5;
    else
        x3 = - (r1^2 - r2^2 - x1^2 + x2^2 - y1^2 + y2^2)/(2*(x1 - x2)) - ((y1 - y2)*(x1*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - x2*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - r1^2*y1 + r1^2*y2 + r2^2*y1 - r2^2*y2 + x1^2*y1 + x1^2*y2 + x2^2*y1 + x2^2*y2 - y1*y2^2 - y1^2*y2 + y1^3 + y2^3 - 2*x1*x2*y1 - 2*x1*x2*y2))/(2*(x1 - x2)*(x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2));
    end
    y3 = (x1*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - x2*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - r1^2*y1 + r1^2*y2 + r2^2*y1 - r2^2*y2 + x1^2*y1 + x1^2*y2 + x2^2*y1 + x2^2*y2 - y1*y2^2 - y1^2*y2 + y1^3 + y2^3 - 2*x1*x2*y1 - 2*x1*x2*y2)/(2*(x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2));
else
    if x1==x2
        x3 = (r1^2-((y1-y2)*r1/(r1+r2))^2)^0.5;
    else
        x3 = - (r1^2 - r2^2 - x1^2 + x2^2 - y1^2 + y2^2)/(2*(x1 - x2)) - ((y1 - y2)*(x2*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - x1*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - r1^2*y1 + r1^2*y2 + r2^2*y1 - r2^2*y2 + x1^2*y1 + x1^2*y2 + x2^2*y1 + x2^2*y2 - y1*y2^2 - y1^2*y2 + y1^3 + y2^3 - 2*x1*x2*y1 - 2*x1*x2*y2))/(2*(x1 - x2)*(x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2));
    end
    y3 = (x2*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - x1*((- r1^2 + 2*r1*r2 - r2^2 + x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2)*(r1^2 + 2*r1*r2 + r2^2 - x1^2 + 2*x1*x2 - x2^2 - y1^2 + 2*y1*y2 - y2^2))^(1/2) - r1^2*y1 + r1^2*y2 + r2^2*y1 - r2^2*y2 + x1^2*y1 + x1^2*y2 + x2^2*y1 + x2^2*y2 - y1*y2^2 - y1^2*y2 + y1^3 + y2^3 - 2*x1*x2*y1 - 2*x1*x2*y2)/(2*(x1^2 - 2*x1*x2 + x2^2 + y1^2 - 2*y1*y2 + y2^2));
end

p_knee = [x3; y3];

end

